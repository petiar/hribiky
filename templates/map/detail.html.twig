{# templates/rozcestnik/detail.html.twig #}
{% extends 'base.html.twig' %}

{% if mushroom.altitude is not empty %}
    {% set title = mushroom.title ~ ' (' ~ mushroom.altitude ~ ' m n. m.)' %}
{% else %}
    {% set title = mushroom.title %}
{% endif %}

{% block title %}{{ title }}{% endblock %}

{% block ogtags %}
    <meta property="og:title" content="{{ title }}"/>
    <meta property="og:type" content="place"/>
    <meta property="og:url" content="{{ url('mushroom_detail', { id: mushroom.id}) }}"/>
    {% if mushroom.photos is defined and mushroom.photos|length > 0 %}
    <meta property="og:image" content="{{ absolute_url(asset('uploads/photos/' ~ mushroom.photos.0.path)) }}"/>
    {% endif %}
    <meta property="og:description" content="{{ mushroom.description }}"/>
    <meta property="og:site_name" content="{{ 'site_name'|trans }}"/>
    <meta property="place:location:latitude" content="{{ mushroom.latitude }}">
    <meta property="place:location:longitude" content="{{ mushroom.longitude }}">
{% endblock %}

{% block body %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h2 class="mb-4">{{ title }}</h2>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>{{ 'mushroom.added_by'|trans }}:</strong> {{ mushroom.name }}
                                ({{ mushroom.createdAt|date('d.m.Y H:i') }})
                            </li>

                            <li class="list-group-item"><strong>GPS:</strong>
                                {% if (mushroom.country == "CZ") %}
                                    <a href="https://mapy.com/en/turisticka?x={{ mushroom.longitude }}&y={{ mushroom.latitude }}&z=14" target="_blank">{{ mushroom.latitude }}, {{ mushroom.longitude }}</a>
                                {% else %}
                                    <a href="https://mapy.dennikn.sk/?x={{ mushroom.longitude }}&y={{ mushroom.latitude }}" target="_blank">{{ mushroom.latitude }}, {{ mushroom.longitude }}</a>
                                {% endif %}
                            </li>
                            <li class="list-group-item">{{ mushroom.description|default('-') }}</li>
                        </ul>
                    </div>
                </div>
                <div class="text-center mb-5">
                    <a href="{{ path('app_home') }}" class="btn btn-outline-primary">
                        ← {{ 'back_to_map'|trans }}
                    </a>
                </div>
            </div>

            <!-- Pravý stĺpec: fotky -->
            <div class="col-md-6">
                {% if mushroom.photos|length > 0 %}
                    <div id="mushroomCarousel" class="carousel slide shadow-sm" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for foto in mushroom.photos %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <img src="{{ asset('uploads/photos/' ~ foto.path) }}" class="d-block w-100 rounded"
                                         alt="Foto">
                                </div>
                            {% endfor %}
                        </div>
                        {% if mushroom.photos|length > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#mushroomCarousel"
                                    data-bs-slide="prev">
                                <span class="carousel-control-prev-icon"></span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#mushroomCarousel"
                                    data-bs-slide="next">
                                <span class="carousel-control-next-icon"></span>
                            </button>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-muted">{{ 'mushroom.no_photos'|trans }}</p>
                {% endif %}
            </div>
        </div>

        <div class="mt-5">
            {% if mushroom.updates|length > 0 %}
                {% for update in mushroom.updates %}
                    <div class="card mb-4 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Aktualizácia od {{ update.name|default('Neznámy autor') }}</h5>
                            <p class="card-text">{{ update.description|default('Bez popisu') }}</p>
                            <p class="text-muted small">{{ update.createdAt|date('d.m.Y H:i') }}</p>

                            {% if update.photos|length > 0 %}
                                <div class="row mt-3">
                                    {% for foto in update.photos %}
                                        <div class="col-6 col-md-3 mb-3">
                                            <img src="{{ asset('uploads/photos/' ~ foto.path) }}"
                                                 class="img-fluid rounded shadow-sm update-foto"
                                                 alt="Update foto"
                                                 data-bs-toggle="modal"
                                                 data-bs-target="#lightboxModal"
                                                 data-bs-src="{{ asset('uploads/photos/' ~ foto.path) }}">
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">{{ 'mushroom.no_comments'|trans }}</p>
            {% endif %}
        </div>
    </div>
    <div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-body p-0 text-center">
                    <img src="" id="lightboxImage" class="img-fluid rounded" alt="Zväčšená fotka">
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {% set countries = {
        'SK': 'Slovakia',
        'CZ': 'Czech Republic',
        'PL': 'Poland'
    } %}
    {% set pageUrl = absolute_url(path('mushroom_detail', {'id': mushroom.id})) %}
    {% set firstPhoto = mushroom.photos|first %}
    <script type="application/ld+json">
{{ {
            "@context": "https://schema.org",
            "@type": "TouristAttraction",
            "@id": url('mushroom_detail', { id: mushroom.id}),
            "name": mushroom.title,
            "description": mushroom.description ?? "",
            "url": pageUrl,
            "mainEntityOfPage": pageUrl,
            "isAccessibleForFree": true,
            "identifier": mushroom.id,
            "geo": {
                "@type": "GeoCoordinates",
                "latitude": mushroom.latitude,
                "longitude": mushroom.longitude,
                "elevation": mushroom.altitude
            },
            "image": firstPhoto ? { "@id": pageUrl ~ "#photo-1" } : null,
            "containedInPlace": mushroom.country ? {
                "@type": "Country",
                "name": countries[mushroom.country]|default(mushroom.country)
            } : null
        } | json_encode(constant('JSON_UNESCAPED_UNICODE') b-or constant('JSON_UNESCAPED_SLASHES')) | raw }}
</script>
    <script type="application/ld+json">
{{ {
            "@context": "https://schema.org",
            "@type": "WebPage",
            "@id": pageUrl,
            "url": pageUrl,
            "datePublished": mushroom.createdAt|date('c'),
            "dateModified": (mushroom.lastModified ?? mushroom.createdAt)|date('c')
        } | json_encode(constant('JSON_UNESCAPED_UNICODE') b-or constant('JSON_UNESCAPED_SLASHES')) | raw }}
</script>
    {% if firstPhoto %}
        <script type="application/ld+json">
{{ {
                "@context": "https://schema.org",
                "@type": "ImageObject",
                "@id": pageUrl ~ "#photo-1",
                "contentUrl": absolute_url(asset('uploads/photos/' ~ firstPhoto.path)),
                "url": absolute_url(asset('uploads/photos/' ~ firstPhoto.path)),
                "dateCreated": mushroom.createdAt|date('c')
            } | json_encode(constant('JSON_UNESCAPED_UNICODE') b-or constant('JSON_UNESCAPED_SLASHES')) | raw }}
</script>
    {% endif %}
{% endblock %}
